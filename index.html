<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BeforeSatoshi Live Bubble Map Organic</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden; /* prevent scroll */
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start; /* desktop: normal flow */
  background: #0a0a0f;
  font-family: sans-serif;
  color: #fff;
}

header { 
  text-align: center; 
  margin: 13px 0 10px 0;
}
header h2 { 
  font-size: 15px; 
  margin: 4px 0; 
  color: #fff; 
  font-weight: 400; 
}
header h1 { 
  font-size: 26px; 
  margin: 0; 
}
header h1 .before { color: #fff; }
header h1 .satoshi { color: #ff8c00; }

#buttons { 
  margin: 10px 0 14px 0;
}
button {
  margin: 0 4px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  background: #222;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
}
button.active { background: #ff8c00; color: #000; }

#container {
  width: 90vw;
  height: 90vh;
  max-width: 95vw;
  max-height: 90vh;
  background: #111;
  border: 2px solid #ff8c00;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 25px #ff8c00;
}

svg { width: 100%; height: 100%; }

text {
  font-weight: 700;
  pointer-events: none;
  font-size: 12px;
  text-anchor: middle;
  fill: #fff;
  text-shadow: 1px 1px 2px #000;
}

#popup {
  position: absolute;
  top: -200px;
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  border: 2px solid #ff8c00;
  border-radius: 10px;
  padding: 10px 15px;
  color: #fff;
  opacity: 0;
  transition: 0.3s;
  z-index: 10;
}
#popup .close { cursor: pointer; float: right; margin-left: 10px; }

#fund { margin-top: 8px; font-size: 12px; }
#fund span.wallet { color: #fff; }
#fund span.label { color: orange; font-weight: 700; margin-right: 4px; }
#popup img { vertical-align: middle; }

/* --- Social icons --- */
#popup .social-icon {
  width: 24px;
  height: 24px;
  margin-right: 6px;
  transition: transform 0.2s ease;
  cursor: pointer;
}
#popup .social-icon:hover {
  transform: scale(1.2);
}

/* --- Desktop popup: doble tama√±o --- */
@media (min-width: 769px) {
  #popup {
    padding: 20px 30px;      /* doble padding */
    font-size: 16px;         /* texto m√°s grande */
    border-width: 4px;       /* borde m√°s grueso */
    border-radius: 14px;     /* m√°s redondeado */
  }
  #popup .social-icon {
    width: 48px;             /* doble tama√±o */
    height: 48px;
    margin-right: 8px;
  }
}

/* --- Mobile adjustments --- */
@media (max-width: 768px) {
  body {
    justify-content: center;
    padding: 0 8px;
  }

  header {
    margin: 10px 0;
  }

  header h2 { 
    font-size: 14px;
    margin: 2px 0; 
  }
  header h1 { 
    font-size: 24px;
    margin: 0; 
  }

  #buttons {
    margin: 8px 0 12px 0;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }

  #buttons button {
    font-size: 16px;
    padding: 8px 14px;
    margin: 4px; 
  }

  #container {
    width: 90vmin;
    height: calc(90vmin * 16 / 9);
    max-height: 85vh;
  }

  #fund { font-size: 14px; }
  #fund span.label, #fund span.wallet { font-size: 14px; }
}
</style>




</head>

<body>



<div id="buttons">
  <button data-period="1">1h</button>
  <button data-period="6">6h</button>
  <button data-period="24" class="active">24h</button>
  <button id="top5Btn">TOP 5</button> <!-- Nuevo bot√≥n -->
</div>


<div id="container">
  <svg id="svg"></svg>
  <div id="popup"></div>
</div>
  
  <header>
  <h2>Powered By</h2>
  <h1><span class="before">Before</span> <span class="satoshi">Satoshi</span></h1>
</header>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(async function () {
  const container = document.getElementById("container");
  const width = container.clientWidth;
  const height = container.clientHeight;
  const svg = d3.select("#svg");
  const popup = document.getElementById("popup");

  let minRadius = 25;
let maxRadius = 125;
let collisionPadding = 6;  // default desktop

function adjustForMobile() {
  if (window.innerWidth <= 768) {
    minRadius = 18;
    maxRadius = 70;
    collisionPadding = 10;
  } else {
    minRadius = 25;
    maxRadius = 125;
    collisionPadding = 6;
  }
}

// Run once initially
adjustForMobile();

  const motionStrength = 0.00009;
  const initialSpeed = 2;
  


  // Tokens
      const tokensData = [
        { pairId: "GNEqyxGV9u8Hz5G3RX1VxUfWCQFuXEP2ckmbLxe1bmyf", logo: "https://i.postimg.cc/FH603Pk6/20250813-191724.jpg", supply: 998918894, xUrl: "https://x.com/example", webUrl: "https://example.com" },
        { pairId: "ENYbntd3KgJJJvMqbe5Awtqu8jkVjnczU8TK46q3odnG", logo: "https://i.postimg.cc/7PBh552s/Gy-Ud-RTy-W4-AM-G6-C.jpg", supply: 919735497 },
        { pairId: "8eQTQLnBmEgeY9avVjrqqgX8ZVr8MRFrXEHpMrx6DGff", logo: "https://i.postimg.cc/zXBL7CNY/H_NjEv35_400x400.jpg", supply: 991423286 },
        { pairId: "3BfzLnxHVaYJNrAP6SxfT7Z8nFe5ybKL6JMTuCrNR8zZ", logo: "https://i.postimg.cc/tJ1jZCKw/frame-00-delay-0-07s.gif", supply: 999973170 },
        { pairId: "C53QBLiDTYhQEgsHKQDS4kEAwEKty1nDkYxF6w67dvBh", logo: "https://i.postimg.cc/q7Qn6rVR/Orynth1.png", supply: 999987561 },
        { pairId: "8Lvqv2jgNvcx1NDtMHd5Ahx8ZUjETfLwygq9MtDfPHxe", logo: "https://i.postimg.cc/3xjHDqq8/FHCTY98-B-400x400.jpg", supply: 999822597 },
        { pairId: "3HP2Gg5sTaNta2ztzrRCA63btYSeyptASkGLcyQXWfBU", logo: "https://i.postimg.cc/T2mG6hc5/Gx85g-A2b-QAA3ea9.jpg", supply: 978962065 },
        { pairId: "DDizsNbsgwgX3icRb6JQ8vFrRa5cN5Nuj6u63dRAoDQv", logo: "https://i.postimg.cc/sgv2YFmV/frame_00_delay-0.07s.png", supply: 999913756 },
        { pairId: "3kZxw7r663dNYqbw8zGCK7NRrcBMXMcRnv3heak4F7mC", logo: "https://i.postimg.cc/bYLD16KR/0-EJccfm2-400x400.jpg", supply: 985372784 },
        { pairId: "3Ko8MN8yqmGBSjNKaoTqapbDLcybecR6zHSQ9o5hHV6i", logo: "https://i.postimg.cc/xjprR7Hf/image-8.png", supply: 828514573 },
        { pairId: "c9EQnny8sBVrkMCKvVua1AQTRSXW1TDw1zLwFLHvRXh", logo: "https://i.postimg.cc/KvxtQGXL/Kkhc6BUo_400x400.jpg", supply: 996370291 },
        { pairId: "95fF8UWoCgjp6kYKV2wZSJB8r7iGhJKRBypcQg75xPRx", logo: "https://i.postimg.cc/tgbCWW9W/Uud988-Dz-400x400.jpg", supply: 999082305 },
        { pairId: "82Q6L714avSh7zE6J43r4u1VUXQ4uYd7C7kHF8T1heAZ", logo: "https://i.postimg.cc/HxBxpnD5/concentrtic.png", supply: 999952763 },
        { pairId: "5snHHUXdB3HZEfF4HeZr1AHjVFgDpqJ1y5XTtYsXkFaN", logo: "https://i.postimg.cc/j2rm85VG/Gxx7oc4-Wk-AEzu-QV.jpg", supply: 999995457 },
        { pairId: "2TYRLY9HgfKmPGmg1ppmeCYRK9uezviKVyoNJLRDtDXH", logo: "https://i.postimg.cc/9MyNqh41/image.jpg", supply: 999994562 },
        { pairId: "8RRTn5vG6bYcyZGpwoGHaqRqJ5DWXBV7QBwvpNkx11qA", logo: "https://i.postimg.cc/1zwKvK93/image-12.png", supply: 998071926 },
        { pairId: "6T49WyxhgXaTyZFPTqxbJxzZYY9RGqBfbdTeUjvPB98d", logo: "https://i.postimg.cc/R057Jnc5/image-13.png", supply: 999821277 },
        { pairId: "JAQH5CqoE4jRzVYTaoC2hxE96N3g6uZN9meo3JQWK4A5", logo: "https://i.postimg.cc/sxLtgX9k/Gyx-Dl-Hs-Xk-AATJs6.jpg", supply: 963269696 },
        { pairId: "3aLbNANFPaAx7ba2xXNpEfbomZif41DyVoKCVXay5da3", logo: "https://i.postimg.cc/152fLr6H/Backyard.jpg", supply: 997436495 },
        { pairId: "CNbqXFEeJX9hvfvDf3z3QtkPz6QWznKzYaUURAKpahGg", logo: "https://i.postimg.cc/fbX2xC7g/Peep.jpg", supply: 999998807 },
        { pairId: "6t5dYv2hJChJMbU2hWPoo6qRh2fh2ghcH4V5aHo7Y6iZ", logo: "https://i.postimg.cc/7PcKQjBQ/Craig.jpg", supply: 996861867 },
        { pairId: "4n7YFdwZbTTr5GayKEivebMpZau2nbZPmbXxYVGyejwJ", logo: "https://i.postimg.cc/wM7RKfB6/PLB.png", supply: 999980363 },
        { pairId: "6PNitzwJuMnZSVFyFejF9MiJzpC4iUqh1XUgfWvdF8WB", logo: "https://i.postimg.cc/rpr5SJHH/MUNCH.png", supply: 999919177 },
        { pairId: "2gFNee5suQKUjDnbMJiVqzzfxsoHwngkMKKsCZdnPscw", logo: "https://i.postimg.cc/KvpTwwSV/DOGE.png", supply: 999905015 },
        { pairId: "XpawVd2GTx9PadC6gEGjztU8gBMbMN4G8i8qoU2GvhA", logo: "https://i.postimg.cc/1RwPLqxZ/Seraph.png", supply: 998964233 },
        { pairId: "CuoioZ7zWayHU6tMS4WmSFeiJvBSxrvTuStk3Mc44cbM", logo: "https://i.postimg.cc/rsMjJyz7/Satoshi.png", supply: 1000000000 },
        { pairId: "GrfYsLtArXKuwRQ2yoWpL7dW9RmGmmhWZbonXZFNfid2", logo: "https://i.postimg.cc/cJ9GPJpy/EURB.png", supply: 999940096 }
        
      ];

  let currentPeriod = "24";

  async function fetchPair(pair) {
    try {
      const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${pair.pairId}`);
      const p = (await res.json()).pairs?.[0];
      if (!p?.baseToken?.symbol) return null;
      return {
        ticker: p.baseToken.symbol,
        price: Number(p.priceUsd),
        change24: Number(p.priceChange?.h24) || 0,
        change6: Number(p.priceChange?.h6) || 0,
        change1: Number(p.priceChange?.h1) || 0,
        logo: pair.logo,
        supply: pair.supply,
        pairId: pair.pairId,
        xUrl: pair.xUrl,
        webUrl: pair.webUrl
      };
    } catch (e) { console.warn("Error", pair.pairId); return null; }
  }

  // ----- INITIAL FETCH -----
  let tokens = (await Promise.allSettled(tokensData.map(fetchPair)))
    .filter(r => r.status === "fulfilled" && r.value)
    .map(r => r.value);

  function getChange(d) { return Number(d["change" + currentPeriod] || 0); }

  function computeRadius(period) {
  const width = container.clientWidth;
  const height = container.clientHeight;
  const maxChange = d3.max(tokens.map(d => Math.abs(Number(d["change" + period] || 0)))) || 1;

  // Fill ~85% of container
  const totalArea = width * height * 0.72;

  // Weights based on absolute change
  let weights = tokens.map(d => Math.abs(Number(d["change" + period] || 0)) / maxChange + 0.1);
  const sumWeights = d3.sum(weights);

  // Compute radii
  tokens.forEach((d,i)=>{
    const frac = weights[i] / sumWeights;
    d.r = Math.sqrt((frac * totalArea)/Math.PI);
    d.r = Math.max(minRadius, Math.min(maxRadius, d.r));
  });
}

function runSimulation() {
  const width = container.clientWidth;
  const height = container.clientHeight;

  const sim = d3.forceSimulation(tokens)
    .force("x", d3.forceX(width/2).strength(0.08))
    .force("y", d3.forceY(height/2).strength(0.08))
    .force("collide", d3.forceCollide(d => d.r + collisionPadding))
    .stop();

  // Increase ticks for tighter packing
  for(let i=0;i<500;i++) sim.tick();

  // Clamp within container
  tokens.forEach(d=>{
    d.x = Math.max(d.r, Math.min(width-d.r, d.x));
    d.y = Math.max(d.r, Math.min(height-d.r, d.y));
    d.vx = (Math.random()-0.5)*initialSpeed;
    d.vy = (Math.random()-0.5)*initialSpeed;
  });
}



  // ----- INITIAL SETUP -----
  computeRadius(currentPeriod);
  runSimulation();

  // ----- NODE CREATION -----
  const node = svg.selectAll("g").data(tokens).enter().append("g")
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .style("cursor","pointer");

  const circles = node.append("circle")
    .attr("r", d => d.r)
    .attr("fill", "none")
    .attr("stroke", d => getChange(d) >= 0 ? "#01fe41" : "#fe0289")
    .attr("stroke-width", 3)
    .style("filter", d => getChange(d) >= 0 ? "drop-shadow(0 0 15px #01fe41)" : "drop-shadow(0 0 15px #fe0289)");

  node.on("mouseover", function(event,d){
    d3.select(this).select("circle")
      .attr("stroke","#fff")
      .style("filter","drop-shadow(0 0 30px #fff)");
  }).on("mouseout", function(event,d){
    d3.select(this).select("circle")
      .attr("stroke",getChange(d)>=0?"#01fe41":"#fe0289")
      .style("filter", getChange(d)>=0?"drop-shadow(0 0 15px #01fe41)":"drop-shadow(0 0 15px #fe0289)");
  });

  node.append("clipPath").attr("id",(d,i)=>`clip-${i}`)
    .append("circle").attr("r",d=>d.r*0.85);

  node.append("image")
    .attr("xlink:href",d=>d.logo)
    .attr("x",d=>-d.r*0.85)
    .attr("y",d=>-d.r*0.85)
    .attr("width",d=>2*d.r*0.85)
    .attr("height",d=>2*d.r*0.85)
    .attr("clip-path",(d,i)=>`url(#clip-${i})`);

  function addTextWithBackground(g,textStr,dy){
    const text=g.append("text").attr("dy",dy).text(textStr)
      .attr("text-anchor","middle").attr("fill","#fff")
      .attr("font-weight","700").style("pointer-events","none")
      .style("text-shadow","2px 2px 4px #000");
    const bbox=text.node().getBBox();
    g.insert("rect","text")
      .attr("x",bbox.x-4).attr("y",bbox.y-2)
      .attr("width",bbox.width+8).attr("height",bbox.height+4)
      .attr("rx",3).attr("fill","rgba(0,0,0,0.5)");
  }

  node.each(function(d){
    addTextWithBackground(d3.select(this),d.ticker,-4);
    addTextWithBackground(d3.select(this),(getChange(d)>0?"+":"")+getChange(d).toFixed(1)+"%",16);
  });

  // ----- POPUP -----
  let popupInterval;
  function updatePopup(d){
    return async function(){
      try{
        const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
        const p = (await res.json()).pairs?.[0];
        if(!p?.baseToken?.symbol) return;
        const price = Number(p.priceUsd);
        const change = Number(p["priceChange"]?.[`h${currentPeriod}`]||0);
        d["change"+currentPeriod]=change;
        const mcap = Math.round(price*d.supply);
        const mcapFormatted = mcap.toLocaleString('en-US');

        const g = d3.selectAll("g").filter(dd=>dd.pairId===d.pairId);
        g.selectAll("text").remove(); g.selectAll("rect").remove();
        addTextWithBackground(g,d.ticker,-4);
        addTextWithBackground(g,(change>0?"+":"")+change.toFixed(1)+"%",16);
        const color = change>=0 ? "#01fe41" : "#fe0289";
        g.select("circle")
          .attr("stroke", color)
          .style("filter", change>=0
            ? "drop-shadow(0 0 15px #01fe41)"
            : "drop-shadow(0 0 15px #fe0289)"
          );

        let socialsHTML='';
        if(d.xUrl) socialsHTML+=`<a href="${d.xUrl}" target="_blank"><img class="social-icon" src="https://i.postimg.cc/ncpwFVXC/XICON2.png"></a>`;
        if(d.webUrl) socialsHTML+=`<a href="${d.webUrl}" target="_blank"><img class="social-icon" src="https://i.postimg.cc/9Fbgr391/WICON2.png"></a>`;

        popup.innerHTML=`<span class="close">‚úï</span>
          <b style="color:yellow">${p.baseToken.symbol}</b><br>
          Price: $${price.toFixed(4)}<br>
          MCAP: $${mcapFormatted}<br>
          Change ${currentPeriod}h: <span style="color:${change>=0?'#01fe41':'#fe0289'}">
  ${(change>0?"+":"")+change.toFixed(2)}%
</span>
<br>
          ${socialsHTML}
          <span style="font-size:10px;color:#aaa">Last updated: ${new Date().toLocaleTimeString()}</span>`;
      }catch(e){console.warn("Error updating popup",d.pairId);}
    };
  }

  node.on("click",(event,d)=>{
    if(popupInterval) clearInterval(popupInterval);
    const updater=updatePopup(d);
    updater();
    popupInterval=setInterval(updater,60000);
    popup.style.top="20px"; popup.style.opacity="1";

    const closeBtn = popup.querySelector(".close");
    if(closeBtn) closeBtn.onclick=()=>{ popup.style.opacity="0"; popup.style.top="-200px"; clearInterval(popupInterval);}
    event.stopPropagation();
  });

  document.addEventListener("click",()=>{ popup.style.opacity="0"; popup.style.top="-200px"; if(popupInterval) clearInterval(popupInterval); });

  let mouse={x:width/2,y:height/2};
  svg.on("mousemove",(event)=>{
    const [mx,my]=d3.pointer(event);
    mouse.x=mx; mouse.y=my;
  });

  // ----- ANIMATION & COLLISION -----
  function animate(){
    tokens.forEach(d=>{
      const dx=mouse.x-d.x, dy=mouse.y-d.y;
      d.vx+=dx*motionStrength; d.vy+=dy*motionStrength;
    });
    tokens.forEach(d=>{
      d.x+=d.vx; d.y+=d.vy;
      d.vx*=0.98; d.vy*=0.98;
      if(d.x-d.r<0){d.x=d.r; d.vx*=-1;}
      if(d.x+d.r>width){d.x=width-d.r; d.vx*=-1;}
      if(d.y-d.r<0){d.y=d.r; d.vy*=-1;}
      if(d.y+d.r>height){d.y=height-d.r; d.vy*=-1;}
    });
    for(let i=0;i<tokens.length;i++){
      for(let j=i+1;j<tokens.length;j++){
        const a=tokens[i], b=tokens[j];
        const dx=b.x-a.x, dy=b.y-a.y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const minDist=a.r+b.r+collisionPadding;
        if(dist<minDist){
          const overlap=(minDist-dist)/2;
          const nx=dx/dist, ny=dy/dist;
          a.x-=nx*overlap; a.y-=ny*overlap;
          b.x+=nx*overlap; b.y+=ny*overlap;
          const dot=(a.vx-b.vx)*nx+(a.vy-b.vy)*ny;
          if(dot>0){
            const k=dot*0.5;
            a.vx-=k*nx; a.vy-=k*ny;
            b.vx+=k*nx; b.vy+=k*ny;
          }
        }
      }
    }
    node.attr("transform",d=>`translate(${d.x},${d.y})`);
    requestAnimationFrame(animate);
  }
  animate();

  // ----- BUTTONS -----
document.querySelectorAll("#buttons button").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    // Si es TOP 5, manejaremos aparte
    if(btn.id === "top5Btn") return; // lo dejamos para el siguiente bloque

    document.querySelectorAll("#buttons button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentPeriod = btn.dataset.period;

    // Restore all nodes visible
    node.style("display", "block");

    await Promise.all(tokens.map(async d=>{
      try {
        const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
        const p = (await res.json()).pairs?.[0];
        if(p?.baseToken?.symbol){
          d["change1"] = Number(p.priceChange?.h1 || 0);
          d["change6"] = Number(p.priceChange?.h6 || 0);
          d["change24"] = Number(p.priceChange?.h24 || 0);
        }
      } catch(e){ console.warn("Error fetching", d.pairId); }
    }));

    computeRadius(currentPeriod);
    runSimulation();

    circles.transition().duration(500)
      .attr("r", d=>d.r)
      .attr("stroke", d=>getChange(d)>=0?"#01fe41":"#fe0289")
      .style("filter", d=>getChange(d)>=0?"drop-shadow(0 0 15px #01fe41)":"drop-shadow(0 0 15px #fe0289)");

    svg.selectAll("clipPath circle").transition().duration(500).attr("r", d=>d.r*0.85);

    node.select("image").transition().duration(500)
      .attr("x", d=>-d.r*0.85).attr("y", d=>-d.r*0.85)
      .attr("width", d=>2*d.r*0.85)
      .attr("height", d=>2*d.r*0.85);

    node.each(function(d){
      const g = d3.select(this);
      g.selectAll("text").remove(); g.selectAll("rect").remove();
      addTextWithBackground(g, d.ticker, -4);
      addTextWithBackground(g, (getChange(d)>0?"+":"")+getChange(d).toFixed(1)+"%", 16);
    });
  });
});

// ----- TOP 5 BUTTON -----
const top5Btn = document.getElementById("top5Btn");
top5Btn.addEventListener("click", async ()=>{
  document.querySelectorAll("#buttons button").forEach(b => b.classList.remove("active"));
  top5Btn.classList.add("active");

  // Obtener MCAP de cada token
  await Promise.all(tokens.map(async d=>{
    try {
      const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
      const p = (await res.json()).pairs?.[0];
      if(p?.baseToken?.symbol){
        d.price = Number(p.priceUsd);
        d.mcap = d.price * d.supply;
      }
    } catch(e){ console.warn("Error fetching", d.pairId); }
  }));

  // Top 5 tokens por MCAP
  const topTokens = tokens.sort((a,b)=>b.mcap - a.mcap).slice(0,5);

  // Mostrar solo top 5
  node.style("display", d => topTokens.includes(d) ? "block" : "none");

  // Ajustar radii proporcional al MCAP
  const minTop = d3.min(topTokens.map(d => d.mcap));
  const maxTop = d3.max(topTokens.map(d => d.mcap));
  topTokens.forEach(d=>{
    d.r = minRadius + (d.mcap - minTop)/(maxTop - minTop) * (maxRadius - minRadius);
  });

  // Reposicionar top 5 en el centro
  const width = container.clientWidth;
  const height = container.clientHeight;
  const sim = d3.forceSimulation(topTokens)
    .force("x", d3.forceX(width/2).strength(0.1))
    .force("y", d3.forceY(height/2).strength(0.1))
    .force("collide", d3.forceCollide(d => d.r + collisionPadding))
    .stop();

  for(let i=0;i<500;i++) sim.tick();

  topTokens.forEach(d=>{
    d.x = Math.max(d.r, Math.min(width-d.r, d.x));
    d.y = Math.max(d.r, Math.min(height-d.r, d.y));
  });

  node.transition().duration(500)
    .attr("transform", d=>`translate(${d.x},${d.y})`)
    .select("circle")
    .attr("r", d=>d.r);

  node.select("clipPath circle").transition().duration(500)
    .attr("r", d=>d.r*0.85);

  node.select("image").transition().duration(500)
    .attr("x", d=>-d.r*0.85)
    .attr("y", d=>-d.r*0.85)
    .attr("width", d=>2*d.r*0.85)
    .attr("height", d=>2*d.r*0.85);
});

  window.addEventListener("resize", () => {
  // üîπ Adjust radius and collision padding for mobile
  adjustForMobile();

  const width = container.clientWidth;
  const height = container.clientHeight;

  // 1Ô∏è‚É£ Recompute radii
  computeRadius(currentPeriod);

  // 2Ô∏è‚É£ Re-run simulation to reposition bubbles
  runSimulation();
  
  // 3Ô∏è‚É£ Update bubble positions
  node.attr("transform", d => `translate(${d.x},${d.y})`);

  // 4Ô∏è‚É£ Update circle radius
  node.select("circle").attr("r", d => d.r);

  // 5Ô∏è‚É£ Update clipPath radius
  node.select("clipPath circle").attr("r", d => d.r * 0.85);

  // 6Ô∏è‚É£ Update image size & position
  node.select("image")
      .attr("x", d => -d.r * 0.85)
      .attr("y", d => -d.r * 0.85)
      .attr("width", d => 2 * d.r * 0.85)
      .attr("height", d => 2 * d.r * 0.85);

  // 7Ô∏è‚É£ Update text labels
  node.each(function(d){
    const g = d3.select(this);
    g.selectAll("text").remove();
    g.selectAll("rect").remove();
    addTextWithBackground(g, d.ticker, -4);
    addTextWithBackground(g, (getChange(d) > 0 ? "+" : "") + getChange(d).toFixed(1) + "%", 16);
  });
});




})();
</script>
</body>
</html>








