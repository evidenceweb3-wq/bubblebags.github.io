<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BeforeSatoshi Live Bubble Map Organic</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden; /* prevent scroll */
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start; /* desktop: normal flow */
  background: #0a0a0f;
  font-family: sans-serif;
  color: #fff;
}

header { 
  text-align: center; 
  margin: 13px 0 10px 0;
}
header h2 { 
  font-size: 15px; 
  margin: 4px 0; 
  color: #fff; 
  font-weight: 400; 
}
header h1 { 
  font-size: 26px; 
  margin: 0; 
}
header h1 .before { color: #fff; }
header h1 .satoshi { color: #ff8c00; }

#buttons { 
  margin: 10px 0 14px 0;
}
button {
  margin: 0 4px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  background: #222;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
}
button.active { background: #ff8c00; color: #000; }

#container {
  width: 90vw;
  height: 90vh;
  max-width: 95vw;
  max-height: 90vh;
  background: #111;
  border: 2px solid #ff8c00;
  border-radius: 12px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 25px #ff8c00;
}

svg { width: 100%; height: 100%; }

text {
  font-weight: 700;
  pointer-events: none;
  font-size: 12px;
  text-anchor: middle;
  fill: #fff;
  text-shadow: 1px 1px 2px #000;
}

#popup {
  position: absolute;
  top: -200px;
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  border: 2px solid #ff8c00;
  border-radius: 10px;
  padding: 10px 15px;
  color: #fff;
  opacity: 0;
  transition: 0.3s;
  z-index: 10;
}
#popup .close { cursor: pointer; float: right; margin-left: 10px; }

#fund { margin-top: 8px; font-size: 12px; }
#fund span.wallet { color: #fff; }
#fund span.label { color: orange; font-weight: 700; margin-right: 4px; }
#popup img { vertical-align: middle; }

/* --- NEW: Social icons --- */
#popup .social-icon {
  width: 24px;   /* bigger size */
  height: 24px;
  margin-right: 6px;
  transition: transform 0.2s ease;
  cursor: pointer;
}
#popup .social-icon:hover {
  transform: scale(1.2); /* hover effect */
}

/* --- Mobile adjustments --- */
@media (max-width: 768px) {
  body {
    justify-content: center; /* vertically center all content */
    padding: 0 8px;
  }

  header {
    margin: 10px 0; /* tighter spacing on mobile */
  }

  header h2 { 
    font-size: 14px;
    margin: 2px 0; 
  }
  header h1 { 
    font-size: 24px;
    margin: 0; 
  }

  #buttons {
    margin: 8px 0 12px 0;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
  }

  #buttons button {
    font-size: 16px;
    padding: 8px 14px;
    margin: 4px; 
  }

  #container {
    width: 90vmin;
    height: calc(90vmin * 16 / 9); /* mobile: 9:16 vertical */
    max-height: 85vh;
  }

  #fund { font-size: 14px; }
  #fund span.label, #fund span.wallet { font-size: 14px; }
}
</style>



</head>

<body>



<div id="buttons">
  <button data-period="1">1h</button>
  <button data-period="6">6h</button>
  <button data-period="24" class="active">24h</button>
</div>

<div id="container">
  <svg id="svg"></svg>
  <div id="popup"></div>
</div>
  
  <header>
  <h2>Powered By</h2>
  <h1><span class="before">Before</span> <span class="satoshi">Satoshi</span></h1>
</header>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(async function () {
  const container = document.getElementById("container");
  const width = container.clientWidth;
  const height = container.clientHeight;
  const svg = d3.select("#svg");
  const popup = document.getElementById("popup");

  let minRadius = 25;
let maxRadius = 125;
let collisionPadding = 6;  // default desktop

function adjustForMobile() {
  if (window.innerWidth <= 768) {
    minRadius = 18;
    maxRadius = 70;
    collisionPadding = 10;
  } else {
    minRadius = 25;
    maxRadius = 125;
    collisionPadding = 6;
  }
}

// Run once initially
adjustForMobile();

  const motionStrength = 0.00009;
  const initialSpeed = 2;
  


  // Tokens
      const tokensData = [
        { pairId: "DMWkUZ8gwdC27BNi4FrK2amCDxMqQQ525ALfNAEVQq62", logo: "https://postimg.cc/vDY2cGXv", supply: 1000000000 }
        
      ];

  let currentPeriod = "24";

  async function fetchPair(pair) {
    try {
      const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${pair.pairId}`);
      const p = (await res.json()).pairs?.[0];
      if (!p?.baseToken?.symbol) return null;
      return {
        ticker: p.baseToken.symbol,
        price: Number(p.priceUsd),
        change24: Number(p.priceChange?.h24) || 0,
        change6: Number(p.priceChange?.h6) || 0,
        change1: Number(p.priceChange?.h1) || 0,
        logo: pair.logo,
        supply: pair.supply,
        pairId: pair.pairId,
        xUrl: pair.xUrl,
        webUrl: pair.webUrl
      };
    } catch (e) { console.warn("Error", pair.pairId); return null; }
  }

  // ----- INITIAL FETCH -----
  let tokens = (await Promise.allSettled(tokensData.map(fetchPair)))
    .filter(r => r.status === "fulfilled" && r.value)
    .map(r => r.value);

  function getChange(d) { return Number(d["change" + currentPeriod] || 0); }

  function computeRadius(period) {
  const width = container.clientWidth;
  const height = container.clientHeight;
  const maxChange = d3.max(tokens.map(d => Math.abs(Number(d["change" + period] || 0)))) || 1;

  // Fill ~85% of container
  const totalArea = width * height * 0.72;

  // Exaggerated weights based on absolute change
let weights = tokens.map(d => {
  let change = Math.abs(Number(d["change" + period] || 0));
  return Math.pow(change / maxChange, 2) + 0.05;  // squared exaggeration
});
const sumWeights = d3.sum(weights);


  // Compute radii
  tokens.forEach((d,i)=>{
    const frac = weights[i] / sumWeights;
    d.r = Math.sqrt((frac * totalArea)/Math.PI);
    d.r = Math.max(minRadius, Math.min(maxRadius, d.r));
  });
}

function runSimulation() {
  const width = container.clientWidth;
  const height = container.clientHeight;

  const sim = d3.forceSimulation(tokens)
    .force("x", d3.forceX(width/2).strength(0.08))
    .force("y", d3.forceY(height/2).strength(0.08))
    .force("collide", d3.forceCollide(d => d.r + collisionPadding))
    .stop();

  // Increase ticks for tighter packing
  for(let i=0;i<500;i++) sim.tick();

  // Clamp within container
  tokens.forEach(d=>{
    d.x = Math.max(d.r, Math.min(width-d.r, d.x));
    d.y = Math.max(d.r, Math.min(height-d.r, d.y));
    d.vx = (Math.random()-0.5)*initialSpeed;
    d.vy = (Math.random()-0.5)*initialSpeed;
  });
}



  // ----- INITIAL SETUP -----
  computeRadius(currentPeriod);
  runSimulation();

  // ----- NODE CREATION -----
  const node = svg.selectAll("g").data(tokens).enter().append("g")
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .style("cursor","pointer");

  const circles = node.append("circle")
    .attr("r", d => d.r)
    .attr("fill", "none")
    .attr("stroke", d => getChange(d) >= 0 ? "#01fe41" : "#fe0289")
    .attr("stroke-width", 3)
    .style("filter", d => getChange(d) >= 0 ? "drop-shadow(0 0 15px #01fe41)" : "drop-shadow(0 0 15px #fe0289)");

  node.on("mouseover", function(event,d){
    d3.select(this).select("circle")
      .attr("stroke","#fff")
      .style("filter","drop-shadow(0 0 30px #fff)");
  }).on("mouseout", function(event,d){
    d3.select(this).select("circle")
      .attr("stroke",getChange(d)>=0?"#01fe41":"#fe0289")
      .style("filter", getChange(d)>=0?"drop-shadow(0 0 15px #01fe41)":"drop-shadow(0 0 15px #fe0289)");
  });

  node.append("clipPath").attr("id",(d,i)=>`clip-${i}`)
    .append("circle").attr("r",d=>d.r*0.85);

  node.append("image")
    .attr("xlink:href",d=>d.logo)
    .attr("x",d=>-d.r*0.85)
    .attr("y",d=>-d.r*0.85)
    .attr("width",d=>2*d.r*0.85)
    .attr("height",d=>2*d.r*0.85)
    .attr("clip-path",(d,i)=>`url(#clip-${i})`);

  function addTextWithBackground(g,textStr,dy){
    const text=g.append("text").attr("dy",dy).text(textStr)
      .attr("text-anchor","middle").attr("fill","#fff")
      .attr("font-weight","700").style("pointer-events","none")
      .style("text-shadow","2px 2px 4px #000");
    const bbox=text.node().getBBox();
    g.insert("rect","text")
      .attr("x",bbox.x-4).attr("y",bbox.y-2)
      .attr("width",bbox.width+8).attr("height",bbox.height+4)
      .attr("rx",3).attr("fill","rgba(0,0,0,0.5)");
  }

  node.each(function(d){
    addTextWithBackground(d3.select(this),d.ticker,-4);
    addTextWithBackground(d3.select(this),(getChange(d)>0?"+":"")+getChange(d).toFixed(1)+"%",16);
  });

  // ----- POPUP -----
  let popupInterval;
  function updatePopup(d){
    return async function(){
      try{
        const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
        const p = (await res.json()).pairs?.[0];
        if(!p?.baseToken?.symbol) return;
        const price = Number(p.priceUsd);
        const change = Number(p["priceChange"]?.[`h${currentPeriod}`]||0);
        d["change"+currentPeriod]=change;
        const mcap = Math.round(price*d.supply);
        const mcapFormatted = mcap.toLocaleString('en-US');

        const g = d3.selectAll("g").filter(dd=>dd.pairId===d.pairId);
        g.selectAll("text").remove(); g.selectAll("rect").remove();
        addTextWithBackground(g,d.ticker,-4);
        addTextWithBackground(g,(change>0?"+":"")+change.toFixed(1)+"%",16);
        const color = change>=0 ? "#01fe41" : "#fe0289";
        g.select("circle")
          .attr("stroke", color)
          .style("filter", change>=0
            ? "drop-shadow(0 0 15px #01fe41)"
            : "drop-shadow(0 0 15px #fe0289)"
          );

        let socialsHTML='';
        if(d.xUrl) socialsHTML+=`<a href="${d.xUrl}" target="_blank"><img class="social-icon" src="https://i.postimg.cc/ncpwFVXC/XICON2.png"></a>`;
        if(d.webUrl) socialsHTML+=`<a href="${d.webUrl}" target="_blank"><img class="social-icon" src="https://i.postimg.cc/9Fbgr391/WICON2.png"></a>`;

        popup.innerHTML=`<span class="close">âœ•</span>
          <b style="color:yellow">${p.baseToken.symbol}</b><br>
          Price: $${price.toFixed(4)}<br>
          MCAP: $${mcapFormatted}<br>
          Change ${currentPeriod}h: <span style="color:${change>=0?'#01fe41':'#fe0289'}">
  ${(change>0?"+":"")+change.toFixed(2)}%
</span>
<br>
          ${socialsHTML}
          <span style="font-size:10px;color:#aaa">Last updated: ${new Date().toLocaleTimeString()}</span>`;
      }catch(e){console.warn("Error updating popup",d.pairId);}
    };
  }

  node.on("click",(event,d)=>{
    if(popupInterval) clearInterval(popupInterval);
    const updater=updatePopup(d);
    updater();
    popupInterval=setInterval(updater,60000);
    popup.style.top="20px"; popup.style.opacity="1";

    const closeBtn = popup.querySelector(".close");
    if(closeBtn) closeBtn.onclick=()=>{ popup.style.opacity="0"; popup.style.top="-200px"; clearInterval(popupInterval);}
    event.stopPropagation();
  });

  document.addEventListener("click",()=>{ popup.style.opacity="0"; popup.style.top="-200px"; if(popupInterval) clearInterval(popupInterval); });

  let mouse={x:width/2,y:height/2};
  svg.on("mousemove",(event)=>{
    const [mx,my]=d3.pointer(event);
    mouse.x=mx; mouse.y=my;
  });

  // ----- ANIMATION & COLLISION -----
  function animate(){
    tokens.forEach(d=>{
      const dx=mouse.x-d.x, dy=mouse.y-d.y;
      d.vx+=dx*motionStrength; d.vy+=dy*motionStrength;
    });
    tokens.forEach(d=>{
      d.x+=d.vx; d.y+=d.vy;
      d.vx*=0.98; d.vy*=0.98;
      if(d.x-d.r<0){d.x=d.r; d.vx*=-1;}
      if(d.x+d.r>width){d.x=width-d.r; d.vx*=-1;}
      if(d.y-d.r<0){d.y=d.r; d.vy*=-1;}
      if(d.y+d.r>height){d.y=height-d.r; d.vy*=-1;}
    });
    for(let i=0;i<tokens.length;i++){
      for(let j=i+1;j<tokens.length;j++){
        const a=tokens[i], b=tokens[j];
        const dx=b.x-a.x, dy=b.y-a.y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const minDist=a.r+b.r+collisionPadding;
        if(dist<minDist){
          const overlap=(minDist-dist)/2;
          const nx=dx/dist, ny=dy/dist;
          a.x-=nx*overlap; a.y-=ny*overlap;
          b.x+=nx*overlap; b.y+=ny*overlap;
          const dot=(a.vx-b.vx)*nx+(a.vy-b.vy)*ny;
          if(dot>0){
            const k=dot*0.5;
            a.vx-=k*nx; a.vy-=k*ny;
            b.vx+=k*nx; b.vy+=k*ny;
          }
        }
      }
    }
    node.attr("transform",d=>`translate(${d.x},${d.y})`);
    requestAnimationFrame(animate);
  }
  animate();

  // ----- BUTTONS -----
  document.querySelectorAll("#buttons button").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      document.querySelectorAll("#buttons button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentPeriod = btn.dataset.period;

      await Promise.all(tokens.map(async d=>{
        try {
          const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
          const p = (await res.json()).pairs?.[0];
          if(p?.baseToken?.symbol){
            d["change1"] = Number(p.priceChange?.h1 || 0);
            d["change6"] = Number(p.priceChange?.h6 || 0);
            d["change24"] = Number(p.priceChange?.h24 || 0);
          }
        } catch(e){ console.warn("Error fetching", d.pairId); }
      }));

      computeRadius(currentPeriod);
      runSimulation();

      circles.transition().duration(500)
        .attr("r", d=>d.r)
        .attr("stroke", d=>getChange(d)>=0?"#01fe41":"#fe0289")
        .style("filter", d=>getChange(d)>=0?"drop-shadow(0 0 15px #01fe41)":"drop-shadow(0 0 15px #fe0289)");

      svg.selectAll("clipPath circle").transition().duration(500).attr("r", d=>d.r*0.85);

      node.select("image").transition().duration(500)
        .attr("x", d=>-d.r*0.85).attr("y", d=>-d.r*0.85)
        .attr("width", d=>2*d.r*0.85).attr("height", d=>2*d.r*0.85);

      node.each(function(d){
        const g = d3.select(this);
        g.selectAll("text").remove(); g.selectAll("rect").remove();
        addTextWithBackground(g, d.ticker, -4);
        addTextWithBackground(g, (getChange(d)>0?"+":"")+getChange(d).toFixed(1)+"%", 16);
      });
    });
  });

  window.addEventListener("resize", () => {
  // ðŸ”¹ Adjust radius and collision padding for mobile
  adjustForMobile();

  const width = container.clientWidth;
  const height = container.clientHeight;

  // 1ï¸âƒ£ Recompute radii
  computeRadius(currentPeriod);

  // 2ï¸âƒ£ Re-run simulation to reposition bubbles
  runSimulation();
  
  // 3ï¸âƒ£ Update bubble positions
  node.attr("transform", d => `translate(${d.x},${d.y})`);

  // 4ï¸âƒ£ Update circle radius
  node.select("circle").attr("r", d => d.r);

  // 5ï¸âƒ£ Update clipPath radius
  node.select("clipPath circle").attr("r", d => d.r * 0.85);

  // 6ï¸âƒ£ Update image size & position
  node.select("image")
      .attr("x", d => -d.r * 0.85)
      .attr("y", d => -d.r * 0.85)
      .attr("width", d => 2 * d.r * 0.85)
      .attr("height", d => 2 * d.r * 0.85);

  // 7ï¸âƒ£ Update text labels
  node.each(function(d){
    const g = d3.select(this);
    g.selectAll("text").remove();
    g.selectAll("rect").remove();
    addTextWithBackground(g, d.ticker, -4);
    addTextWithBackground(g, (getChange(d) > 0 ? "+" : "") + getChange(d).toFixed(1) + "%", 16);
  });
});




})();
</script>
</body>
</html>



