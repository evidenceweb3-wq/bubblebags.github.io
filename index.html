<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BeforeSatoshi Live Bubble Map Organic</title>
<style>
body { margin:0; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; background:#0a0a0f; font-family:sans-serif; color:#fff; }
header { text-align:center; margin:8px 0; }
header h2 { font-size:14px; margin:0; color:#fff; font-weight:400; }
header h1 { font-size:24px; margin:0; }
header h1 .before { color:#fff; }
header h1 .satoshi { color:#ff8c00; }
#buttons { margin-bottom:8px; }
button { margin:0 4px; padding:4px 10px; border:none; border-radius:4px; background:#222; color:#fff; cursor:pointer; }
button.active { background:#ff8c00; color:#000; }
#container { width:80vmin; height:80vmin; background:#111; border:2px solid #ff8c00; border-radius:12px; position:relative; overflow:hidden; box-shadow:0 0 25px #ff8c00; user-select:none; }
svg { width:100%; height:100%; }
text { font-weight:700; pointer-events:none; font-size:12px; text-anchor:middle; fill:#fff; text-shadow: 1px 1px 2px #000; }
#popup { position:absolute; top:-200px; left:50%; transform:translateX(-50%); background:#222; border:2px solid #ff8c00; border-radius:10px; padding:10px 15px; color:#fff; opacity:0; transition:0.3s; z-index:10; }
#popup .close { cursor:pointer; float:right; margin-left:10px; }
#fund { margin-top:8px; font-size:12px; }
#fund span.wallet { color:#fff; }
#fund span.label { color:orange; font-weight:700; margin-right:4px; }
</style>
</head>
<body>

<header>
  <h2>Powered By</h2>
  <h1><span class="before">Before</span> <span class="satoshi">Satoshi</span></h1>
</header>

<div id="buttons">
  <button data-period="1">1h</button>
  <button data-period="6">6h</button>
  <button data-period="24" class="active">24h</button>
</div>

<div id="container">
  <svg id="svg"></svg>
  <div id="popup"></div>
</div>
<div id="fund"><span class="label">FUND US:</span> <span class="wallet">HFs2KJxfp6jraXc69v2ouuDNTVfTm8er78UYQqqWuQP5</span></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(async function(){
const container = document.getElementById("container");
const width = container.clientWidth;
const height = container.clientHeight;
const svg = d3.select("#svg");
const popup = document.getElementById("popup");

const minRadius = 25;
const maxRadius = 80;
const collisionPadding = 5;
const motionStrength = 0.00008;
const initialSpeed = 0.15;

// ---- SUPPLY ADDED TO EACH TOKEN ----
const tokensData = [
  {pairId:"GNEqyxGV9u8Hz5G3RX1VxUfWCQFuXEP2ckmbLxe1bmyf", logo:"https://i.postimg.cc/FH603Pk6/20250813-191724.jpg", supply:998918894},
  {pairId:"ENYbntd3KgJJJvMqbe5Awtqu8jkVjnczU8TK46q3odnG", logo:"https://i.postimg.cc/7PBh552s/Gy-Ud-RTy-W4-AM-G6-C.jpg", supply:919735497},
  {pairId:"8eQTQLnBmEgeY9avVjrqqgX8ZVr8MRFrXEHpMrx6DGff", logo:"https://i.postimg.cc/zXBL7CNY/H_NjEv35_400x400.jpg", supply:991423286},
  {pairId:"3BfzLnxHVaYJNrAP6SxfT7Z8nFe5ybKL6JMTuCrNR8zZ", logo:"https://i.postimg.cc/tJ1jZCKw/frame-00-delay-0-07s.gif", supply:999973170},
  {pairId:"C53QBLiDTYhQEgsHKQDS4kEAwEKty1nDkYxF6w67dvBh", logo:"https://i.postimg.cc/q7Qn6rVR/Orynth1.png", supply:999987561},
  {pairId:"8Lvqv2jgNvcx1NDtMHd5Ahx8ZUjETfLwygq9MtDfPHxe", logo:"https://i.postimg.cc/3xjHDqq8/FHCTY98-B-400x400.jpg", supply:999822597},
  {pairId:"3HP2Gg5sTaNta2ztzrRCA63btYSeyptASkGLcyQXWfBU", logo:"https://i.postimg.cc/T2mG6hc5/Gx85g-A2b-QAA3ea9.jpg", supply:978962065},
  {pairId:"DDizsNbsgwgX3icRb6JQ8vFrRa5cN5Nuj6u63dRAoDQv", logo:"https://i.postimg.cc/sgv2YFmV/frame_00_delay-0.07s.png", supply:999913756},
  {pairId:"3kZxw7r663dNYqbw8zGCK7NRrcBMXMcRnv3heak4F7mC", logo:"https://i.postimg.cc/bYLD16KR/0-EJccfm2-400x400.jpg", supply:985372784},
  {pairId:"3Ko8MN8yqmGBSjNKaoTqapbDLcybecR6zHSQ9o5hHV6i", logo:"https://i.postimg.cc/xjprR7Hf/image-8.png", supply:828514573},
  {pairId:"c9EQnny8sBVrkMCKvVua1AQTRSXW1TDw1zLwFLHvRXh", logo:"https://i.postimg.cc/KvxtQGXL/Kkhc6BUo_400x400.jpg", supply:996370291}
];

async function fetchPair(pair){
  try {
    const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${pair.pairId}`);
    const p = (await res.json()).pairs?.[0];
    if(!p?.baseToken?.symbol) return null;
    return {
      ticker: p.baseToken.symbol,
      price: Number(p.priceUsd),
      change24: Number(p.priceChange?.h24) || 0,
      change6: Number(p.priceChange?.h6) || 0,
      change1: Number(p.priceChange?.h1) || 0,
      logo: pair.logo,
      supply: pair.supply,
      pairId: pair.pairId
    };
  } catch(e){ console.warn("Error", pair.pairId); return null; }
}

let tokens = (await Promise.allSettled(tokensData.map(fetchPair)))
  .filter(r=>r.status==="fulfilled" && r.value)
  .map(r=>r.value);

let currentPeriod = "24";

function computeRadius(period){
  const scale = d3.scaleSqrt()
    .domain([0,d3.max(tokens,d=>Math.abs(d["change"+period]))])
    .range([minRadius,maxRadius]);
  tokens.forEach(d=> d.r = scale(Math.abs(d["change"+period])));
}

computeRadius(currentPeriod);

const padding = 10;
tokens.forEach((d,i)=>{
  const angle = (i / tokens.length) * Math.PI * 2;
  d.x = width/2 + Math.cos(angle) * (width/2 - d.r - padding);
  d.y = height/2 + Math.sin(angle) * (height/2 - d.r - padding);
  d.vx = (Math.random()-0.5)*initialSpeed;
  d.vy = (Math.random()-0.5)*initialSpeed;
});

const node = svg.selectAll("g").data(tokens).enter().append("g")
  .attr("transform", d=>`translate(${d.x},${d.y})`)
  .style("cursor","pointer");

const circles = node.append("circle")
  .attr("r", d=>d.r)
  .attr("fill","none")
  .attr("stroke", d=>d["change"+currentPeriod]>=0?"#16ff00":"#ff3d3d")
  .attr("stroke-width",3)
  .style("filter", d=>d["change"+currentPeriod]>=0?"drop-shadow(0 0 15px #16ff00)":"drop-shadow(0 0 15px #ff3d3d)");

// Hover
node.on("mouseover", function(event,d){
  d3.select(this).select("circle")
    .style("stroke","#fff")
    .style("filter","drop-shadow(0 0 30px #fff)");
})
.on("mouseout", function(event,d){
  d3.select(this).select("circle")
    .style("stroke", d["change"+currentPeriod]>=0?"#16ff00":"#ff3d3d")
    .style("filter", d["change"+currentPeriod]>=0?"drop-shadow(0 0 15px #16ff00)":"drop-shadow(0 0 15px #ff3d3d)");
});

node.append("clipPath").attr("id",(d,i)=>`clip-${i}`)
  .append("circle").attr("r",d=>d.r*0.85).attr("cx",0).attr("cy",0);

node.append("image")
  .attr("xlink:href", d=>d.logo)
  .attr("x", d=>-d.r*0.85)
  .attr("y", d=>-d.r*0.85)
  .attr("width", d=>2*d.r*0.85)
  .attr("height", d=>2*d.r*0.85)
  .attr("clip-path",(d,i)=>`url(#clip-${i})`);

node.append("text").attr("dy",-4).text(d=>d.ticker).style("text-shadow","1px 1px 2px #000");
node.append("text").attr("dy",16).text(d=> (d["change"+currentPeriod]>0?"+":"") + d["change"+currentPeriod].toFixed(1)+"%").style("text-shadow","1px 1px 2px #000");

// ---- POPUP ----
let popupInterval;

function updatePopup(d) {
  return async function() {
    try {
      const res = await fetch(`https://api.dexscreener.com/latest/dex/pairs/solana/${d.pairId}`);
      const p = (await res.json()).pairs?.[0];
      if (!p?.baseToken?.symbol) return;

      const price = Number(p.priceUsd);
      const change = Number(p["priceChange"]?.[`h${currentPeriod}`] || 0);
      const mcap = Math.round(price * d.supply);
      const mcapFormatted = mcap.toLocaleString('en-US');

      popup.innerHTML = `<span class="close">âœ•</span>
        <b>${p.baseToken.symbol}</b><br>
        Price: $${price.toFixed(4)}<br>
        MCAP: $${mcapFormatted}<br>
        Change ${currentPeriod}h: <span style="color:${change>=0?'#16ff00':'#ff3d3d'}">${(change>0?"+":"")+change.toFixed(2)}%</span><br>
        <span style="font-size:10px;color:#aaa">Last updated: ${new Date().toLocaleTimeString()}</span>`;
    } catch(e){ console.warn("Error updating popup", d.pairId); }
  };
}

node.on("click", (event, d) => {
  if (popupInterval) clearInterval(popupInterval);
  const updater = updatePopup(d);
  updater(); // show immediately
  popupInterval = setInterval(updater, 60000); // refresh every 60s

  popup.style.top = "20px";
  popup.style.opacity = "1";

  const closeBtn = popup.querySelector(".close");
  if (closeBtn) closeBtn.onclick = () => {
    popup.style.opacity = "0";
    popup.style.top = "-200px";
    clearInterval(popupInterval);
  };

  event.stopPropagation();
});

document.addEventListener("click",()=>{ 
  popup.style.opacity = "0"; 
  popup.style.top="-200px"; 
  if(popupInterval) clearInterval(popupInterval);
});

let mouse = {x:width/2, y:height/2};
svg.on("mousemove",(event)=>{ const [mx,my] = d3.pointer(event); mouse.x=mx; mouse.y=my; });

function animate(){
  tokens.forEach(d=>{
    d.x += d.vx; d.y += d.vy;
    d.vx += (mouse.x-d.x)*motionStrength;
    d.vy += (mouse.y-d.y)*motionStrength;
    d.x = Math.max(d.r, Math.min(width-d.r,d.x));
    d.y = Math.max(d.r, Math.min(height-d.r,d.y));
  });
  for(let i=0;i<tokens.length;i++){
    for(let j=i+1;j<tokens.length;j++){
      const a=tokens[i], b=tokens[j];
      const dx=b.x-a.x, dy=b.y-a.y, dist=Math.sqrt(dx*dx+dy*dy), minDist=a.r+b.r+collisionPadding;
      if(dist<minDist){
        const angle=Math.atan2(dy,dx), overlap=(minDist-dist)*0.5;
        a.x-=Math.cos(angle)*overlap; a.y-=Math.sin(angle)*overlap;
        b.x+=Math.cos(angle)*overlap; b.y+=Math.sin(angle)*overlap;
      }
    }
  }
  node.attr("transform",d=>`translate(${d.x},${d.y})`);
  requestAnimationFrame(animate);
}

animate();

document.querySelectorAll("#buttons button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    currentPeriod=btn.dataset.period;
    document.querySelectorAll("#buttons button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    computeRadius(currentPeriod);
    node.select("circle").attr("r",d=>d.r).attr("stroke", d=>d["change"+currentPeriod]>=0?"#16ff00":"#ff3d3d");
    node.select("clipPath circle").attr("r",d=>d.r*0.85);
    node.select("image").attr("x",d=>-d.r*0.85).attr("y",d=>-d.r*0.85).attr("width",d=>2*d.r*0.85).attr("height",d=>2*d.r*0.85);
    node.selectAll("text").filter((d,i)=>i%2===1).text(d=> (d["change"+currentPeriod]>0?"+":"") + d["change"+currentPeriod].toFixed(1) + "%");
  });
});
})();
</script>
</body>
</html>
